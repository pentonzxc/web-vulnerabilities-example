<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="#" />
  </head>
  <body>
    <div id="postsContainer"></div>

    <script nonce="rAnd0m">
      let url = window.location.href;
      let segments = url.split("/");
      let login = segments[segments.length - 1];

      function fetchPosts(currentUrl) {
        console.log("Request posts");
        fetch(currentUrl, {
          method: "GET",
          headers: {
            Accept: "application/json",
          },
        })
          .then((response) => {
            if (response.status != "200") {
              response.text().then((errorCode) => {
                const container = document.getElementById("postsContainer");
                container.innerHTML = `Error response: ${errorCode}`;
              });

              throw new Error("Can't request posts");
            }
            return response.json();
          })
          .then((data) => {
            data.forEach((post) => {
              createPost(post);
            });
          });
      }

      function deletePost(postId) {
        // Send a DELETE request to the server to delete the post with the specified postId
        fetch(`/posts/${postId}?login=${login}`, {
          method: "DELETE",
        })
          .then((response) => {
            if (response.status <= 400) {
              // If the post is successfully deleted, remove the post element from the DOM
              const postElement = document.getElementById(postId);
              if (postElement) {
                postElement.remove();
              }
            } else {
              console.error("Failed to delete post");
            }
          })
          .catch((error) => {
            console.error("Error deleting post:", error);
          });
      }

      function createPost(post) {
        const container = document.getElementById("postsContainer");

        const postElement = document.createElement("div");
        postElement.id = `${post.id}`;
        postElement.innerHTML = `
            <h3>${post.content}</h3>
            <h4>${post.id}</h4>
            <p>Posted by: ${post.userId}</p>
            <button nonce="rAnd0m" onclick="deletePost('${post.id}')">Delete</button>
            <hr>`;
        console.log(post);

        container.appendChild(postElement);
      }

      fetchPosts(url);
    </script>
  </body>
</html>
